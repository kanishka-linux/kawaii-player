<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Browse and discover your favorite series with advanced filtering options">
    <meta name="keywords" content="series, anime, movies, tv shows, browse, filter">
    <meta name="author" content="Series Browser">
    
    <title>Browse Series - Series Browser</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="browse.css">
    
    <!-- Theme color for mobile browsers -->
    <meta name="theme-color" content="#007bff">
    <meta name="msapplication-TileColor" content="#007bff">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Main Content -->
    <main class="main-content" id="main-content" role="main">
        <div class="container">
            
            <!-- Alert Messages -->
            <div id="alert-container" class="alert-container" role="alert" aria-live="polite"></div>
            
            <!-- Page Content with Sidebar Layout -->
            <div class="page-layout">
                
                <!-- Sidebar Toggle Button -->
                <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle filters sidebar">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                
                <!-- Sidebar Overlay (for mobile) -->
                <div class="sidebar-overlay" id="sidebar-overlay"></div>
                
                <!-- Filters Sidebar -->
                <aside class="filters-sidebar" id="filters-sidebar">
                    <div class="sidebar-header">
                        <h2>Filter & Search</h2>
                        <button class="sidebar-close" id="sidebar-close" aria-label="Close filters">
                            <span class="close-icon">√ó</span>
                        </button>
                    </div>
                    
                    <div class="sidebar-content">
                        <form method="GET" action="/browse" id="browse-form">
                            <input type="hidden" name="limit" id="limit-hidden" value="$current_limit">
                            <input type="hidden" name="view" id="view-hidden" value="$current_view">
                            <div class="filter-group">
                                <label for="search">Search:</label>
                                <input type="text" name="search" id="search" value="$search" 
                                       placeholder="Search titles..." autocomplete="off">
                            </div>
                            
                            <div class="filter-group">
                                <label for="category">Category:</label>
                                <select name="category" id="category">
                                    <option value="">All Categories</option>
                                    $category_options
                                </select>
                            </div>

                            <div class="filter-group">
                                <label for="labels">Labels:</label>
                                <select name="labels" id="labels">
                                    <option value="">All Labels</option>
                                    $labels_options
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="genres">Genres:</label>
                                <select id="genres" name="genres" data-placeholder="Select genres" multiple class="js-multiselect">
                                    $genre_options
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="year_from">Year Range:</label>
                                <div class="year-range">
                                    <select name="year_from" id="year_from" class="js-year-from">
                                        <option value="">From</option>
                                        $year_from_options
                                    </select>
                                    <span class="year-separator">to</span>
                                    <select name="year_to" id="year_to" class="js-year-to">
                                        <option value="">To</option>
                                        $year_to_options
                                    </select>
                                </div>
                            </div>
                            
                            <div class="filter-group">
                                <label for="type">Type:</label>
                                <select name="type" id="type">
                                    <option value="">All Types</option>
                                    $type_options
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="sort">Sort By:</label>
                                <select name="sort" id="sort">
                                    <option value="title" $title_selected>Title</option>
                                    <option value="year" $year_selected>Year</option>
                                    <option value="score" $score_selected>Score</option>
                                    <option value="popularity" $popularity_selected>Popularity</option>
                                    <option value="rank" $rank_selected>Rank</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label for="order">Order:</label>
                                <select name="order" id="order">
                                    <option value="asc" $asc_selected>Ascending</option>
                                    <option value="desc" $desc_selected>Descending</option>
                                </select>
                            </div>
                            
                            <div class="filter-actions">
                                <button type="submit" class="btn js-apply-filters">
                                    <span class="btn-icon">üîç</span>
                                    Apply Filters
                                </button>
                                <button type="button" class="btn btn-secondary js-clear-filters">
                                    <span class="btn-icon">‚úñÔ∏è</span>
                                    Clear All
                                </button>
                            </div>
                        </form>
                    </div>
                </aside>

                <!-- Main Content Area -->
                <div class="main-area">
                    <!-- Results Header -->
                    <div class="results-header">
                        
                        <div class="header-controls">

                            <!-- NEW: Quick Sort Controls -->
                            <div class="quick-sort-controls">
                                
                                <select name="sort" id="quick-sort" class="js-quick-sort">
                                    <option value="title" $title_selected>üìù Title</option>
                                    <option value="year" $year_selected>üóìÔ∏è Year</option>
                                    <option value="score" $score_selected>‚≠ê Score</option>
                                    <option value="popularity" $popularity_selected>üî• Popular</option>
                                    <option value="rank" $rank_selected>üèÜ Rank</option>
                                </select>
                                
                                <!-- Single Order Toggle Button -->
                                <button class="order-toggle js-order-toggle" data-order="$current_order" title="Toggle sort order">
                                    <span class="order-icon">$order_icon</span>
                                </button>
                            </div>
                            
                            <!-- View toggle buttons -->
                            <div class="view-options">
                                <button class="view-toggle $grid_view_active js-view-toggle" data-view="grid" aria-label="Grid view" title="Grid view">
                                    <span class="view-icon view-icon-grid"></span>
                                </button>
                                <button class="view-toggle $list_view_active js-view-toggle" data-view="list" aria-label="List view" title="List view">
                                    <span class="view-icon view-icon-list"></span>
                                </button>
                                <button class="view-toggle $text_view_active js-view-toggle" data-view="text" aria-label="Text view" title="Text view">
                                    <span class="view-icon view-icon-text"></span>
                                </button>
                            </div>
                        </div>
<div class="results-left">
                            <div class="results-info" aria-live="polite">
                                Showing $results_start-$results_end of $total_count series
                            </div>
                            <!-- NEW: Pagination Limit Control -->
                            <div class="limit-control">
                                <select name="limit" id="limit" class="js-limit-select">
                                    <option value="25" $limit_25_selected>25</option>
                                    <option value="100" $limit_100_selected>100</option>
                                    <option value="500" $limit_500_selected>500</option>
                                    <option value="1000" $limit_1000_selected>1000</option>
                                    <option value="2000" $limit_2000_selected>2000</option>
                                    <option value="5000" $limit_5000_selected>5000</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Series Grid -->
                    <div class="$series_grid_class" id="series-grid" $series_grid_display role="main" aria-label="Series results">
                        $series_cards
                    </div>

                    <!-- Text List View -->
                    <div class="text-list-view js-text-list" id="text-list" $text_list_display data-generated="$text_list_generated">
                        <!-- A-Z Navigation -->
                        <nav class="alphabet-nav" id="alphabet-nav">
                            <a href="#letter-a" class="alphabet-link" data-letter="a">A</a>
                            <a href="#letter-b" class="alphabet-link" data-letter="b">B</a>
                            <a href="#letter-c" class="alphabet-link" data-letter="c">C</a>
                            <a href="#letter-d" class="alphabet-link" data-letter="d">D</a>
                            <a href="#letter-e" class="alphabet-link" data-letter="e">E</a>
                            <a href="#letter-f" class="alphabet-link" data-letter="f">F</a>
                            <a href="#letter-g" class="alphabet-link" data-letter="g">G</a>
                            <a href="#letter-h" class="alphabet-link" data-letter="h">H</a>
                            <a href="#letter-i" class="alphabet-link" data-letter="i">I</a>
                            <a href="#letter-j" class="alphabet-link" data-letter="j">J</a>
                            <a href="#letter-k" class="alphabet-link" data-letter="k">K</a>
                            <a href="#letter-l" class="alphabet-link" data-letter="l">L</a>
                            <a href="#letter-m" class="alphabet-link" data-letter="m">M</a>
                            <a href="#letter-n" class="alphabet-link" data-letter="n">N</a>
                            <a href="#letter-o" class="alphabet-link" data-letter="o">O</a>
                            <a href="#letter-p" class="alphabet-link" data-letter="p">P</a>
                            <a href="#letter-q" class="alphabet-link" data-letter="q">Q</a>
                            <a href="#letter-r" class="alphabet-link" data-letter="r">R</a>
                            <a href="#letter-s" class="alphabet-link" data-letter="s">S</a>
                            <a href="#letter-t" class="alphabet-link" data-letter="t">T</a>
                            <a href="#letter-u" class="alphabet-link" data-letter="u">U</a>
                            <a href="#letter-v" class="alphabet-link" data-letter="v">V</a>
                            <a href="#letter-w" class="alphabet-link" data-letter="w">W</a>
                            <a href="#letter-x" class="alphabet-link" data-letter="x">X</a>
                            <a href="#letter-y" class="alphabet-link" data-letter="y">Y</a>
                            <a href="#letter-z" class="alphabet-link" data-letter="z">Z</a>
                            <a href="#letter-other" class="alphabet-link" data-letter="other">#</a>
                        </nav>
                        
                        <!-- Text list content -->
                        <div class="text-list-content" id="text-list-content">
                            $text_list_html
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination" role="navigation" aria-label="Pagination">
                        $pagination_html
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Back to Top Button -->
    <button class="back-to-top" id="back-to-top" aria-label="Back to top">
        <span class="back-to-top-icon">‚Üë</span>
    </button>
    
    <!-- Base JavaScript -->
    <script>
        // Remove loading screen when page is loaded
        window.addEventListener('load', function() {
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                }, 300);
            }
        });
        
        // Mobile navigation toggle
        document.addEventListener('DOMContentLoaded', function() {
            const backToTop = document.getElementById('back-to-top');
            console.log('Back to top button found:', backToTop);
            
            if (backToTop) {
                window.addEventListener('scroll', function() {
                    if (window.pageYOffset > 300) {
                        backToTop.classList.add('visible');
                    } else {
                        backToTop.classList.remove('visible');
                    }
                });
                
                backToTop.addEventListener('click', function() {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                });
            } else {
                console.error('Back to top button NOT found!');
            }

            const navbarToggle = document.getElementById('navbar-toggle');
            const navbarMenu = document.getElementById('navbar-menu');
            
            if (navbarToggle && navbarMenu) {
                navbarToggle.addEventListener('click', function() {
                    navbarMenu.classList.toggle('active');
                    this.classList.toggle('active');
                });
            }
            
            // Sidebar toggle functionality
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebarClose = document.getElementById('sidebar-close');
            const sidebar = document.getElementById('filters-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const body = document.body;
            
            function openSidebar() {
                sidebar.classList.add('open');
                overlay.classList.add('active');
                body.classList.add('sidebar-open');
                sidebarToggle.setAttribute('aria-expanded', 'true');
            }
            
            function closeSidebar() {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
                body.classList.remove('sidebar-open');
                sidebarToggle.setAttribute('aria-expanded', 'false');
            }
            
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    if (sidebar.classList.contains('open')) {
                        closeSidebar();
                    } else {
                        openSidebar();
                    }
                });
            }
            
            if (sidebarClose) {
                sidebarClose.addEventListener('click', closeSidebar);
            }
            
            if (overlay) {
                overlay.addEventListener('click', closeSidebar);
            }
            
            // Close sidebar on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && sidebar.classList.contains('open')) {
                    closeSidebar();
                }
            });
            
            // Quick search functionality
            const quickSearch = document.getElementById('quick-search');
            if (quickSearch) {
                quickSearch.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const query = this.value.trim();
                        if (query) {
                            window.location.href = `/browse?search=${encodeURIComponent(query)}`;
                        }
                    }
                });
            }
            
            // Theme toggle
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', function() {
                    document.body.classList.toggle('light-theme');
                    const icon = this.querySelector('.theme-icon');
                    icon.textContent = document.body.classList.contains('light-theme') ? '‚òÄÔ∏è' : 'üåô';
                });
            }
            
            // Save sidebar state preference
            function saveSidebarState() {
                try {
                    const isOpen = sidebar.classList.contains('open');
                    localStorage.setItem('sidebarOpen', isOpen);
                } catch (e) {
                    console.warn('Could not save sidebar state:', e);
                }
            }
            
            // Load sidebar state preference
            function loadSidebarState() {
                try {
                    const savedState = localStorage.getItem('sidebarOpen');
                    if (savedState === 'true' && window.innerWidth > 768) {
                        openSidebar();
                    }
                } catch (e) {
                    console.warn('Could not load sidebar state:', e);
                }
            }
            
            // Load saved state on page load
            loadSidebarState();
            
            // Save state when sidebar is toggled
            if (sidebar) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            saveSidebarState();
                        }
                    });
                });
                observer.observe(sidebar, { attributes: true });
            }

            const limitSelect = document.querySelector('.js-limit-select');
            const limitHidden = document.getElementById('limit-hidden');
            const viewHidden = document.getElementById('view-hidden');
            const currentView = new URL(window.location.href).searchParams.get('view')
            const browseForm = document.getElementById('browse-form');
            if (limitSelect) {
                limitSelect.addEventListener('change', function() {
                    const currentUrl = new URL(window.location.href);
                    currentUrl.searchParams.set('limit', this.value);
                    currentUrl.searchParams.set('page', '1'); // Reset to page 1
                    window.location.href = currentUrl.toString();
                });
            }

            // When form submits, sync the hidden input with visible select
            if (browseForm) {
                browseForm.addEventListener('submit', function(e) {
                    limitHidden.value = limitSelect.value;
                    viewHidden.value = currentView;
                    if (window.innerWidth <= 768) {
                        closeSidebar();
                    }
                });
            }
        });
        
        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
        });
        
        // Handle window resize
        window.addEventListener('resize', function() {
            const sidebar = document.getElementById('filters-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            // Auto-close sidebar on mobile when resizing to desktop
            if (window.innerWidth > 768 && overlay.classList.contains('active')) {
                overlay.classList.remove('active');
                document.body.classList.remove('sidebar-open');
            }
        });
    </script>
    
    <!-- Browse-specific JavaScript -->
    <script src="browse.js"></script>
</body>
</html>
